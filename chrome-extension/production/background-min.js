var DEV_MODE=!1,inputWindowId=null,timeOfLastRequest=0,dictationMode=!1,lastMessage=null,inputDomain=DEV_MODE?"https://localhost:8000":"https://handsfreechrome.com",inputWindowURL=DEV_MODE?inputDomain+"/html/input.html":inputDomain+"/input",keepShowing=!1,openInputWindow=function(){chrome.storage.sync.get({openInTab:!1},function(e){e.openInTab?chrome.tabs.create({url:inputWindowURL},function(e){inputWindowId=e.id}):chrome.windows.create({url:inputWindowURL,height:300,width:400,left:screen.width-400,top:-10},function(e){inputWindowId=e.id})})};chrome.browserAction.onClicked.addListener(openInputWindow);var sendCommandToControlScript=function(e){chrome.tabs.query({active:!0,windowId:window.id},function(o){var t=o[0],n=t.id;return"close tab"===e||"close time"===e?void chrome.tabs.remove(n):void chrome.tabs.sendMessage(n,e)})},executeMessage=function(e,o){if(!(lastMessage&&lastMessage.startsWith("keep")&&lastMessage.endsWith(e)||"newtown"===lastMessage&&"new tab"===e&&(new Date).getTime()-timeOfLastRequest<1e3)){if(!parseInt(e)&&e===lastMessage&&(new Date).getTime()-timeOfLastRequest<1e3)return void console.log("noticed time");if(lastMessage=e,o||e.startsWith("go to")||(timeOfLastRequest=(new Date).getTime()),o)chrome.windows.getAll({populate:!0},function(o){o.forEach(function(o){o.tabs[0].url!==inputWindowURL&&chrome.tabs.query({active:!0,windowId:o.id},function(o){var t=o[0];chrome.tabs.sendMessage(t.id,e)})})});else{if(console.log("executing: "+e),"done"===e||"Don"===e||"Dunn"===e)return chrome.windows.remove(inputWindowId),void sendCommandToControlScript("hidehelp");chrome.windows.getAll({populate:!0},function(o){o.forEach(function(o){if("quit"===e||"exit"===e)return void chrome.windows.remove(o.id);if(o.tabs[0].url!==inputWindowURL){if("silence"===e||"silent"===e){chrome.tabs.query({windowId:o.id},function(e){e.forEach(function(e){e.active&&chrome.tabs.update(e.id,{muted:!e.mutedInfo.muted})})})}if("full screen"===e)return void("fullscreen"!==o.state?chrome.windows.update(o.id,{state:"fullscreen"}):"fullscreen"===o.state&&chrome.windows.update(o.id,{state:"maximized"}));if("minimize"===e)return void("minimized"!==o.state?chrome.windows.update(o.id,{state:"minimized"}):chrome.windows.update(o.id,{state:"maximized"}));if("maximize"===e&&chrome.windows.update(o.id,{state:"maximized"}),"new tab"===e||"newtown"===e)return void chrome.tabs.create({windowId:o.id});if("switch"===e){var t=!1;chrome.tabs.query({windowId:o.id},function(e){for(var o=0;o<e.length;o++){if(t){chrome.tabs.update(e[o].id,{active:!0});break}if(e[o].active&&(t=!0,o==e.length-1)){chrome.tabs.update(e[0].id,{active:!0});break}}})}sendCommandToControlScript(e)}})})}}};chrome.runtime.onMessageExternal.addListener(function(e,o,t){return console.log("received something"),o.url!==inputWindowURL?(console.log("Nevermind, bad URL from message sender."),void console.log("URL: "+o.url)):e.getAliases?(chrome.storage.sync.get({commandAliases:{}},function(e){t({commandAliases:e.commandAliases})}),!0):e.getTimeoutDuration?(chrome.storage.sync.get({timeoutDuration:18e4},function(e){t({timeoutDuration:e.timeoutDuration})}),!0):void(e.message&&(("CHROME_DICTATION_STOP"===e.message||"CHROME_DICTATION_SUBMIT"===e.message)&&(dictationMode=!1),dictationMode?(console.log("called as dictation: "+e.message),executeMessage(e.message,!0)):(console.log("called as command: "+e.message),executeMessage(e.message,!1))))}),chrome.runtime.onMessage.addListener(function(e,o,t){if(e.greeting.dictModeOn===!0)console.log("turning on dictation mode in the background window"),dictationMode=!0,chrome.windows.get(inputWindowId,{populate:!0},function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){var o=e[0];chrome.tabs.sendMessage(o.id,{dictModeOn:!0})})});else if(e.greeting.dictModeOn===!1)console.log("turning off dictation mode in the background window due to onbeforeunload"),dictationMode=!1,"mainWindow"===e.greeting.origin?chrome.windows.get(inputWindowId,{populate:!0},function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){var o=e[0];chrome.tabs.sendMessage(o.id,{dictModeOn:!1})})}):"inputWindow"===e.greeting.origin&&executeMessage("CHROME_DICTATION_STOP",!1);else if("TOGGLE_EXTENSION_ON_OFF"===e.greeting){var n=!0;chrome.windows.getAll({populate:!0},function(e){e.forEach(function(e){e.tabs[0].url===inputWindowURL&&(chrome.windows.remove(e.id),n=!1)}),n&&openInputWindow()})}else"KEEP_SHOWING"===e.greeting?keepShowing=!0:"STOP_SHOWING"===e.greeting?keepShowing=!1:"SHOW?"===e.greeting&&t(keepShowing)});